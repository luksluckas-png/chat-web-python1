<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Chat</title>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

<style>
body {
    background: #0f0f0f;
    color: white;
    font-family: Arial;
    margin: 0;
}

#chat {
    padding: 10px;
    height: 75vh;
    overflow-y: auto;
}

.msg {
    background: #1e1e1e;
    padding: 8px;
    border-radius: 8px;
    margin-bottom: 6px;
}

.perfil {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
}

.perfil img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

img.chat-img {
    max-width: 100%;
    border-radius: 8px;
}

#input {
    display: flex;
    gap: 5px;
    padding: 10px;
}

input, button {
    padding: 8px;
    border-radius: 6px;
    border: none;
}
</style>
</head>

<body>

<div class="perfil">
    <img id="avatar" src="" alt="foto">
    <input id="nick" placeholder="Seu nome" style="width:100px">
    <input type="file" id="foto" accept="image/*">
</div>

<div id="chat"></div>

<div id="input">
    <input id="msg" placeholder="Mensagem" style="flex:1">
    <input type="file" id="file">
    <button onclick="enviar()">Enviar</button>
</div>

<script>
const socket = io()
const chat = document.getElementById("chat")

// ===== NOME FIXO =====
const nickInput = document.getElementById("nick")
nickInput.value = localStorage.getItem("nick") || ""
nickInput.onchange = () => localStorage.setItem("nick", nickInput.value)

// ===== FOTO DE PERFIL =====
const avatar = document.getElementById("avatar")
const fotoInput = document.getElementById("foto")

const fotoSalva = localStorage.getItem("foto")
if (fotoSalva) avatar.src = fotoSalva

fotoInput.onchange = () => {
    const file = fotoInput.files[0]
    const reader = new FileReader()
    reader.onload = () => {
        localStorage.setItem("foto", reader.result)
        avatar.src = reader.result
    }
    reader.readAsDataURL(file)
}

function enviar() {
    const msg = document.getElementById("msg")
    const nick = nickInput.value || "AnÃ´nimo"
    if (msg.value.trim()) {
        socket.send(`${nick}: ${msg.value}`)
        msg.value = ""
    }
}

socket.on("message", data => {
    chat.innerHTML += `<div class="msg">${data}</div>`
    chat.scrollTop = chat.scrollHeight
})

document.getElementById("file").onchange = () => {
    const file = document.getElementById("file").files[0]
    if (!file) return

    const fd = new FormData()
    fd.append("file", file)

    fetch("/upload", { method: "POST", body: fd })
    .then(r => r.json())
    .then(d => {
        if (d.nome.match(/\.(png|jpg|jpeg|gif|webp)$/i)) {
            chat.innerHTML += `<div class="msg"><img src="${d.url}" class="chat-img"></div>`
        } else {
            chat.innerHTML += `<div class="msg">ðŸ“¦ <a href="${d.url}" target="_blank">${d.nome}</a></div>`
        }
        chat.scrollTop = chat.scrollHeight
    })

    document.getElementById("file").value = ""
}
</script>

</body>
</html>
